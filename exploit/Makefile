# Copyright 2018 FIX94
# This code is licensed to you under the terms of the GNU GPL, version 2;
# see file LICENSE or http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt


# Configuration:

# What toolchain prefix should we use
CROSS ?= powerpc-eabi-

ifeq ($(OS),Windows_NT)
	MKNES = $(CURDIR)/nesrom/tools/ACNESCreator.CommandLine.exe
	CA65 = $(CURDIR)/nesrom/tools/ca65.exe
	LD65 = $(CURDIR)/nesrom/tools/ld65.exe
else
	MKNES = $(CURDIR)/nesrom/tools/ACNESCreator.CommandLine
	CA65 = $(CURDIR)/nesrom/tools/ca65
	LD65 = $(CURDIR)/nesrom/tools/ld65
endif

# End of configuration.



# Set CC, LD, OBJCOPY based on CROSS, unless they are set already

ifeq ($(origin CC), default)
	CC := $(CROSS)gcc -m32
endif
ifeq ($(origin LD), default)
	LD := $(CROSS)ld
endif
OBJCOPY ?= $(CROSS)objcopy


# The compiler flags we need.

CFLAGS := -Wall -W -O1 -ffreestanding -mno-eabi -mno-sdata -mcpu=750


# Build with "V=1" to see the commands executed; be quiet otherwise.

ifeq ($(V),1)
	Q :=
else
	Q := @
	MAKEFLAGS += --no-print-directory
endif


targets := gaej_v100.gci gaej_v101.gci gafe.gci gafj_v100.gci gafj_v101.gci gafp_eng.gci gafp_ger.gci gafp_fre.gci gafp_spa.gci gafp_ita.gci gafu.gci

objs := ac.o start.o

all: $(targets)

gaej_v100.gci: REGION := J
gaej_v100.gci: IS_DNME := 1
gaej_v100.gci: PATCH_PTR := 80291244

gaej_v101.gci: REGION := J
gaej_v101.gci: IS_DNME := 1
gaej_v101.gci: PATCH_PTR := 80291EBC

gafe.gci: REGION := E
gafe.gci: IS_DNME := 0
gafe.gci: PATCH_PTR := 802181E0

gafj_v100.gci: REGION := J
gafj_v100.gci: IS_DNME := 0
gafj_v100.gci: PATCH_PTR := 80217568

gafj_v101.gci: REGION := J
gafj_v101.gci: IS_DNME := 0
gafj_v101.gci: PATCH_PTR := 80217AA8

gafp_eng.gci: REGION := P
gafp_eng.gci: IS_DNME := 0
gafp_eng.gci: PATCH_PTR := 8022BE54

gafp_ger.gci: REGION := P
gafp_ger.gci: IS_DNME := 0
gafp_ger.gci: PATCH_PTR := 8022C874

gafp_fre.gci: REGION := P
gafp_fre.gci: IS_DNME := 0
gafp_fre.gci: PATCH_PTR := 8022D734

gafp_spa.gci: REGION := P
gafp_spa.gci: IS_DNME := 0
gafp_spa.gci: PATCH_PTR := 8022C6F4

gafp_ita.gci: REGION := P
gafp_ita.gci: IS_DNME := 0
gafp_ita.gci: PATCH_PTR := 8022D5F4

gafu.gci: REGION := U
gafu.gci: IS_DNME := 0
gafu.gci: PATCH_PTR := 8022A0A4

$(targets): %.gci : %.dat %.pat
	@echo "  OUTPUT    $@"
	$(Q)mv -f $(filter %.dat,$^) nesrom/resources/loader.bin
	$(Q)$(CA65) nesrom/src/main.asm -g -I nesrom/src --bin-include-dir nesrom -o nesrom/main.o
	$(Q)$(LD65) -C nesrom/ldscripts/nes.ld -o nesrom/main.nes -vm nesrom/main.o
	$(MKNES) LoadDOL nesrom/main.nes $(REGION) $(IS_DNME) $(filter %.pat,$^) $(PATCH_PTR)
	$(Q)mv -f nesrom/LoadDOL_$(REGION)_InjectedData.gci $@

dats := gaej_v100.dat gaej_v101.dat gafe.dat gafj_v100.dat gafj_v101.dat gafp_eng.dat gafp_ger.dat gafp_fre.dat gafp_spa.dat gafp_ita.dat gafu.dat
pats := gaej_v100.pat gaej_v101.pat gafe.pat gafj_v100.pat gafj_v101.pat gafp_eng.pat gafp_ger.pat gafp_fre.pat gafp_spa.pat gafp_ita.pat gafu.pat

$(dats): %.dat: %.elf
	@echo "  OBJCOPY   $@"
	$(Q)$(OBJCOPY) -Obinary $< $@

elfs := $(dats:.dat=.elf)

$(elfs): %.elf: %.ld $(objs)
	@echo "  LINK      $@"
	$(Q)$(LD) -T $^ -o $@

%.o: %.S
	@echo "  ASSEMBLE  $@"
	$(Q)$(CC) $(CFLAGS) -c $< -o $@

%.o: %.c
	@echo "  COMPILE   $@"
	$(Q)$(CC) $(CFLAGS) -c $< -o $@

clean:
	-rm -f $(targets) $(saves) $(elfs) $(objs) $(slots) $(dats) $(pats) loader.h
	-rm -f nesrom/resources/loader.bin nesrom/main.o nesrom/main.nes
